<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (C) 2005 MindQuarry GmbH, All Rights Reserved -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	<map:components>
		<map:actions>
			<map:action name="setnohttpcache"
				src="org.apache.cocoon.acting.HttpCacheAction">
				<seconds>0</seconds>
			</map:action>
			<map:action name="httpauth" src="com.mindquarry.webapp.auth.HttpAuthAction" />
		</map:actions>
		<map:selectors>
			<map:selector name="lightbox-request" src="com.mindquarry.webapp.ajax.LightboxRequestSelector"/>
		</map:selectors>
	</map:components>
	
	<map:views>
		<map:view name="content" from-label="content">
			<map:serialize type="xml"/>
		</map:view>
		
		<map:view name="content" from-label="content">
			<map:serialize type="xml"/>
		</map:view>
		
		<map:view name="html" from-label="html">
			<map:serialize type="xml"/>
		</map:view>
		
		<map:view name="form" from-label="form">
			<map:serialize type="xml"/>
		</map:view>
		
	</map:views>

	<map:flow language="javascript">
		<map:script src="flows/create-teamspace.js" />
		<map:script src="flows/teamspaces-view.js"/>
		<map:script src="flows/edit-members.js"/>
	</map:flow>
	
	<map:resources>
		<map:resource name="layouting">
		<map:select type="lightbox-request">
			<map:when test="true">
				<map:transform src="resource://com/mindquarry/webapp/xsl/html2lightbox.xsl">
	        		<map:parameter name="pathInfo" value="{request:pathInfo}"/>
	        	</map:transform>
	        	<map:serialize type="xhtml"/>
	        </map:when>
	        <map:otherwise>
	      		<map:transform src="resource://com/mindquarry/webapp/xsl/html2html.xsl">
	        		<map:parameter name="pathInfo" value="{request:pathInfo}"/>
	        	</map:transform>
	        	<map:serialize type="xhtml" />
	        </map:otherwise>
			</map:select>
		</map:resource>
		
		<map:resource name="form2html">
			<map:transform src="xslt/forms/form2html.xsl" label="form">
				<map:parameter name="pathInfo" value="{request:pathInfo}" />
			</map:transform>
		</map:resource>
	</map:resources>
	

	<map:pipelines>

		<!-- resources pipeline / use noncaching for debugging -->
		<map:pipeline type="noncaching">
			<map:match pattern="resources/css/*.css">
				<map:read
					src="resource://com/mindquarry/teamspace/css/{1}.css" />
			</map:match>
			<map:match pattern="resources/scripts/*.js">
				<map:read
					src="resource://com/mindquarry/teamspace/scripts/{1}.js" />
			</map:match>
			<map:match pattern="resources/images/*.*">
				<map:read
					src="resource://com/mindquarry/teamspace/images/{1}.{2}" />
			</map:match>
			<map:match pattern="resources/buttons/*.*">
				<map:read
					src="resource://com/mindquarry/teamspace/buttons/{1}_button.{2}" />
			</map:match>
			<map:match pattern="resources/icons/*x*/*/*.png">
				<map:read src="resource://org/tango-project/tango-icon-theme/{1}x{2}/{3}/{4}.png" />
			</map:match>
		</map:pipeline>

		<!-- user pipeline / use noncaching for debugging -->
		<map:pipeline type="noncaching">
			<map:match pattern="users/*.png">
				<map:read
					src="resource://com/mindquarry/teamspace/images/anonymous-user.png" />
			</map:match>
			
			<map:match pattern="teams/*.png">
				<map:read
					src="resource://com/mindquarry/teamspace/images/anonymous-project.png" />
			</map:match>
		</map:pipeline>
		
		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">
			<map:match pattern="">
				<map:act type="httpauth">
					<map:call function="listTeamspacesForUser">
						<map:parameter name="username" value="{username}" />
					</map:call>
				</map:act>
			</map:match>
			<map:match pattern="views/teamspaceView">
				<map:act type="httpauth">
					<map:generate src="jx/teamspace-view.jx" type="jx" label="content"/>
					<map:transform src="xslt/teamspaces2html.xsl" label="html">
						<map:parameter name="pathInfo"
							value="{request:pathInfo}" />
					</map:transform>
	   				<map:call resource="form2html" />
	 				<map:call resource="layouting" />
 				</map:act>
			</map:match>
		</map:pipeline>
		
		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">
			<map:match type="regexp" pattern="([a-z\-]+)/editMembers/$">
				<map:act type="httpauth">
					<map:call function="handleForm">
						<map:parameter name="function"
							value="processEditMembersForm" />
						<map:parameter name="definitionURI"
							value="forms/edit-members-form.xml" />
						<map:parameter name="teamspaceId" value="{1}"/>
					</map:call>
				</map:act>
			</map:match>
		</map:pipeline>
		
		<!-- creating users and teamspace / use noncaching pipeline -->
		<map:pipeline type="noncaching">
		
			<map:match pattern="createUser/">
				<map:act type="httpauth">
					<map:call function="handleForm">
						<map:parameter name="function"
							value="processCreateUserForm" />
						<map:parameter name="definitionURI"
							value="forms/edit-members-form.xml" />
						<map:parameter name="username" value="{username}" />
					</map:call>
				</map:act>
			</map:match>	
			
			<map:match pattern="createTeamspace/">
				<map:act type="httpauth">
					<map:call function="handleForm">
						<map:parameter name="function"
							value="processCreateTeamspaceForm" />
						<map:parameter name="definitionURI"
							value="forms/create-teamspace-form.xml" />
						<map:parameter name="username" value="{username}" />
					</map:call>
				</map:act>
			</map:match>		
		</map:pipeline>
		
		<map:pipeline>			
			<map:match pattern="*.instance">
				<map:generate type="jx" src="forms/{1}-template.xml">
					<map:parameter name="locale"
						value="{flow-attribute:locale}" />
				</map:generate>

				<map:call resource="form2html" />				
				<map:call resource="layouting" />
			</map:match>
			
			<!-- Continue a scenario. The continuation id is passed in the URL
				(typically used for GET requests) -->
			<map:match pattern="**/*.continue">
				<map:act type="setnohttpcache" />
				<map:act type="httpauth">
					<map:call continuation="{../2}" />
				</map:act>
			</map:match>
			<map:match pattern="*.continue">
				<map:act type="setnohttpcache" />
				<map:act type="httpauth">
					<map:call continuation="{../1}" />
				</map:act>
			</map:match>
		</map:pipeline>

	</map:pipelines>

</map:sitemap>