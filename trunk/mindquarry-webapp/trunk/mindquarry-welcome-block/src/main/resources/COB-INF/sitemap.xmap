<?xml version="1.0" encoding="UTF-8"?>

<!--
	Copyright (C) 2006 MindQuarry GmbH, All Rights Reserved
-->
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	<map:components>
		<map:actions>
			<map:action name="httpauth"
					src="com.mindquarry.webapp.auth.HttpAuthAction" />
		</map:actions>
	</map:components>

	<map:pipelines>
		<!-- resources pipeline / use noncaching for debugging -->
		<map:pipeline type="noncaching">
			<map:match pattern="xslt/*.xsl">
				<map:select type="resource-exists">
					<map:when test="xslt/{1}.xsl">
					<!-- if it exists, load it from this sitemap's resources -->
						<map:read
							src="xslt/{1}.xsl" />
					</map:when>
					<!-- if not, look in the super block -->
					<map:otherwise>
						<map:read src="block:super:/xslt/{1}.xsl" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<!-- URLs css/* etc. do not work in the welcome block
				 (css/ will be mis-identified as a block) -->

			<map:match pattern="*.css">
				<map:select type="resource-exists">
					<map:when test="css/{1}.css">
						<map:read
							src="css/{1}.css" />
					</map:when>
					<map:otherwise>
						<map:read src="block:super:/css/{1}.css" />
					</map:otherwise>
				</map:select>
			</map:match>

			<map:match pattern="*.js">
				<map:select type="resource-exists">
					<map:when test="scripts/{1}.js">
						<map:read
							src="scripts/{1}.js" />
					</map:when>
					<map:otherwise>
						<map:read src="block:super:/scripts/{1}.js" />
					</map:otherwise>
				</map:select>
			</map:match>

			<map:match pattern="*.png">
				<map:select type="resource-exists">
					<map:when test="images/{1}.png">
						<map:read
							src="images/{1}.png" />
					</map:when>
					<map:otherwise>
						<map:read src="block:super:/images/{1}.png" />
					</map:otherwise>
				</map:select>
			</map:match>

			<map:match pattern="*.gif">
				<map:select type="resource-exists">
					<map:when test="images/{1}.gif">
						<map:read
							src="images/{1}.gif" />
					</map:when>
					<map:otherwise>
						<map:read src="block:super:/images/{1}.gif" />
					</map:otherwise>
				</map:select>
			</map:match>

		</map:pipeline>

		<map:pipeline>
			<map:match pattern="">
				<map:generate src="html/login.html" />
				<map:transform
					src="block:/xslt/html2html.xsl">
	        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
	        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
	        		<!-- empty css/scripts path -->
	        		<map:parameter name="cssPath" value=""/>
	        		<map:parameter name="scriptPath" value=""/>
					<map:parameter name="user.agent" value="{request-header:User-Agent}" />
				</map:transform>
				<map:serialize type="html" />
			</map:match>
			
			<map:match pattern="welcome">
				<map:act type="httpauth">
					<map:generate src="html/index.html" />
				<map:transform
					src="block:/xslt/html2html.xsl">
	        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
	        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
	        		<!-- empty css/scripts path -->
	        		<map:parameter name="cssPath" value=""/>
	        		<map:parameter name="scriptPath" value=""/>
					<map:parameter name="user.agent" value="{request-header:User-Agent}" />
				</map:transform>
				<map:serialize type="html" />
				</map:act>
			</map:match>

			<!-- redirect stupid urls /foobar to the index page -->
			<map:match pattern="*">
				<map:redirect-to uri="" />
			</map:match>
		</map:pipeline>
	</map:pipelines>
</map:sitemap>
