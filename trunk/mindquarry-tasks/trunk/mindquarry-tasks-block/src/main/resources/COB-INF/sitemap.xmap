<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2006 MindQuarry GmbH, All Rights Reserved
-->
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

	<!-- TASKS -->

	<map:components>
		<map:actions>
			<map:action name="log"
				src="com.mindquarry.webapp.acting.DebugLogAction" />
		</map:actions>
	</map:components>

	<map:pipelines>
		<map:pipeline type="noncaching">

			<!-- @virtual: for even more specific sub-blocks ;-) -->
			<map:match pattern="tasks-dforms-model-directory.xml">
				<map:act type="log" src=">>[tasks] tasks-dforms-model-directory.xml" />
				
				<map:generate src="dforms-model" type="directory" />
				<map:transform
					src="block:super:/directory2resourceincludes.xsl" />
				<map:serialize type="xml" />
			</map:match>

			<!-- @override: provide the model as directory listing for the dforms block -->
			<map:match pattern="dforms-model-directory.xml">
				<map:act type="log" src=">>[tasks] dforms-model-directory.xml" />
				<!-- we want our models and the inherited models -->
				
				<map:aggregate element="resources">
					<map:part
						src="block:super:/dforms-model-directory.xml" />
					<map:part
						src="block:/tasks-dforms-model-directory.xml" />
				</map:aggregate>
				<map:serialize type="xml" />
			</map:match>

			<!-- @override: for inheriting sitemap resources -->
			<map:match pattern="resource/**">
				<map:act type="log" src=">>[tasks] resource/**" />
				
				<map:select type="resource-exists">
					<!-- if it exists, load it from this sitemap's resources -->
					<map:when test="{1}">
						<map:act type="log" src=">>[tasks] exists" />
						<map:read src="{1}" />
					</map:when>
					<!-- if not, look in the super block -->
					<map:otherwise>
						<map:act type="log" src=">>[tasks] does not exist -> super block" />
						<map:read src="block:super:/resource/{1}" />
					</map:otherwise>
				</map:select>
			</map:match>

			<!--+
				| forward any unknown stuff to the super block 
				| NOTE: This must be the last matcher!
				+-->
			<map:match pattern="**">
				<map:act type="log" src=">> tasks **" />
				
				<map:read src="block:super:/{1}" />
			</map:match>

		</map:pipeline>
	</map:pipelines>

</map:sitemap>

