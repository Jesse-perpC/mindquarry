<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2006 MindQuarry GmbH, All Rights Reserved
-->
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

	<!-- TASKS -->

	<map:components>
		<map:actions>
			<map:action name="log"
				src="com.mindquarry.webapp.acting.DebugLogAction" />
			<map:action name="log-params"
				src="com.mindquarry.webapp.acting.LogParametersAction" />

			<map:action name="httpauth" src="com.mindquarry.webapp.auth.HttpAuthAction" />
		</map:actions>

		<map:selectors>
			<map:selector name="lightbox-request" src="com.mindquarry.webapp.ajax.LightboxRequestSelector"/>
			<map:selector name="ajax-request" src="org.apache.cocoon.ajax.AjaxRequestSelector"/>
		</map:selectors>
	</map:components>

	<map:resources>
		<map:resource name="layouting">
			<map:select type="lightbox-request">
				<map:when test="true">
					<map:transform src="block:resources:/xslt/html2lightbox.xsl">
		        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
		        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
						<map:parameter name="user.agent" value="{request-header:User-Agent}" />
		        	</map:transform>
		        </map:when>
		        <map:otherwise>
		      		<map:transform src="block:resources:/xslt/html2html.xsl">
		        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
		        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
						<map:parameter name="user.agent" value="{request-header:User-Agent}" />
		        	</map:transform>
		        </map:otherwise>
				</map:select>
				
				<map:select type="ajax-request">
				    <map:when test="true">
				      <map:serialize type="xml"/>
				    </map:when>
				    <map:otherwise>
				      <map:serialize type="xhtml"/>
				    </map:otherwise>
			</map:select>
		</map:resource>
		
		<map:resource name="form2html">
			<map:transform src="xslt/forms/form2html.xsl" label="form">
        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
			</map:transform>
		</map:resource>
	</map:resources>

	<map:flow language="javascript">
		<map:script src="flow/tasks-view.js" />
	</map:flow>

	<map:pipelines>
		<!-- resources pipeline / use noncaching for debugging -->
		<map:pipeline type="noncaching">
			<map:match pattern="css/*.css">
				<map:select type="resource-exists">
					<map:when test="css/{1}.css">
					<!-- if it exists, load it from this sitemap's resources -->
						<map:read
							src="css/{1}.css" />
					</map:when>
					<!-- if not, look in the super block -->
					<map:otherwise>
						<map:read src="block:resources:/css/{1}.css" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<map:match pattern="xslt/*.xsl">
				<map:select type="resource-exists">
					<map:when test="xslt/{1}.xsl">
					<!-- if it exists, load it from this sitemap's resources -->
						<map:read
							src="xslt/{1}.xsl" />
					</map:when>
					<!-- if not, look in the resources block -->
					<map:otherwise>
						<map:read src="block:resources:/xslt/{1}.xsl" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<map:match pattern="scripts/*.js">
				<map:select type="resource-exists">
					<map:when test="scripts/{1}.js">
						<map:read
							src="scripts/{1}.js" />
					</map:when>
					<map:otherwise>
						<map:read src="block:resources:/scripts/{1}.js" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<map:match pattern="images/*.*">
				<map:select type="resource-exists">
					<map:when test="images/{1}.{2}">
						<map:read
							src="images/{1}.{2}" />
					</map:when>
					<map:otherwise>
						<map:read src="block:resources:/images/{1}.{2}" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<map:match pattern="buttons/*.*">
				<map:select type="resource-exists">
					<map:when test="buttons/{1}_button.{2}">
						<map:read
							src="buttons/{1}_button.{2}" />
					</map:when>
					<map:otherwise>
						<map:read src="block:resources:/buttons/{1}.{2}" />
					</map:otherwise>
				</map:select>
			</map:match>
			
			<map:match pattern="icons/*x*/*/*.png">
				<map:select type="resource-exists">
					<map:when test="icons/{1}x{2}/{3}/{4}.png">
						<map:read
							src="icons/{1}x{2}/{3}/{4}.png" />
					</map:when>
					<map:otherwise>
						<map:read src="block:resources:/icons/{1}x{2}/{3}/{4}.png" />
					</map:otherwise>
				</map:select>
			</map:match>
		</map:pipeline>

		<map:pipeline type="noncaching">

			<!-- @virtual: for even more specific sub-blocks ;-) -->
			<map:match pattern="tasks-dforms-model-directory.xml">
				<map:generate src="dforms-model" type="directory" />
				<map:transform
					src="block:super:/directory2resourceincludes.xsl" />
				<map:serialize type="xml" />
			</map:match>

			<!-- @override: provide the model as directory listing for the dforms block -->
			<map:match pattern="dforms-model-directory.xml">
				<!-- we want our models and the inherited models -->
				<map:aggregate element="resources">
					<map:part
						src="block:super:/dforms-model-directory.xml" />
					<map:part
						src="block:/tasks-dforms-model-directory.xml" />
				</map:aggregate>
				<map:serialize type="xml" />
			</map:match>

			<!-- public -->

			<!--+
				| URL for a task in a certain teamspace:
				| .../tasks/<teamspace-id>/<task-id>.xml
				|
				| JCR path for the task:
				| /teamspaces/<teamspace-id>/tasks/<task-id>.xml
				+-->
			<map:match pattern="*/*.xml">
				<map:generate
					src="block:super:/show-document.xml?baseURI={url-encode:jcr:///teamspaces/{1}/tasks/}&amp;documentID={url-encode:{2}}" />
				<map:call resource="layouting" />
			</map:match>
			
			<map:match pattern="*/*.xml.edit">
				<map:generate
					src="block:super:/edit-document.xml?baseURI={url-encode:jcr:///teamspaces/{1}/tasks/}&amp;documentID={url-encode:{2}}" />			
				<map:act type="log" src="fullPath: {block-path:}{request:pathInfo}" />
				<map:act type="log" src="sitemapPath: {request:pathInfo}" />
				<map:call resource="layouting" />
			</map:match>
			
		</map:pipeline>

		<!-- tasks overview / use noncaching -->
		<map:pipeline type="noncaching">
			<map:match pattern="">
				<map:act type="httpauth">
					<map:call function="tasksView">
						<map:parameter name="username" value="{username}" />						
						<map:parameter name="target" value="views/tasksView"/>
					</map:call>
				</map:act>
			</map:match>
			
			<map:match pattern="views/tasksView">
				<map:generate src="jx/tasks-view.jx" type="jx" />
				<map:transform src="xslt/tasks2html.xsl">
	        		<map:parameter name="fullPath" value="{block-path:}{request:pathInfo}"/>
	        		<map:parameter name="sitemapPath" value="{request:pathInfo}"/>
				</map:transform>
				<map:call resource="layouting" />
			</map:match>
		</map:pipeline>

			<!-- =========================================================== -->

		<map:pipeline type="noncaching">
			<!-- @override: for inheriting sitemap resources -->
			<map:match pattern="resource/**">
				<map:select type="resource-exists">
					<!-- if it exists, load it from this sitemap's resources -->
					<map:when test="{1}">
						<map:read src="{1}" />
					</map:when>
					<!-- if not, look in the super block -->
					<map:otherwise>
						<map:read src="block:super:/resource/{1}" />
					</map:otherwise>
				</map:select>
			</map:match>

			<map:match pattern="*/*.xml.*.continue">
				<map:act type="log-params" />
				<map:read src="block:super:/{3}.continue?baseURI={url-encode:jcr:///teamspaces/{1}/tasks/}&amp;documentID={url-encode:{2}}&amp;{params-as-uri:request-param}" />
			</map:match>

			<!--+
				| forward any unknown stuff to the super block 
				| NOTE: This must be the last matcher!
				+-->
			<map:match pattern="**">
				<map:read src="block:super:/{1}" />
			</map:match>

		</map:pipeline>
	</map:pipelines>

</map:sitemap>

