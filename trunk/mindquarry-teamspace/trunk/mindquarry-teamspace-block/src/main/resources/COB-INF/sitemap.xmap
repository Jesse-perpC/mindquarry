<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (C) 2005 MindQuarry GmbH, All Rights Reserved -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	<map:components>
		<map:actions>
			<map:action name="setnohttpcache"
				src="org.apache.cocoon.acting.HttpCacheAction">
				<seconds>0</seconds>
			</map:action>
		</map:actions>
	</map:components>
	
	<map:flow language="javascript">
		<map:script src="flows/admin.js" />
         <map:script src="flows/teamspaces-view.js"/>
    	<map:script src="flows/edit-members.js"/>
	</map:flow>
	
	<map:resources>
		<map:resource name="layouting">	        
        	<map:transform src="resource://com/mindquarry/webapp/xsl/html2html.xsl">
        		<map:parameter name="pathInfo" value="{request:pathInfo}"/>
        	</map:transform>
        	<map:serialize type="xhtml"/>
		</map:resource>
	</map:resources>
	
	<map:pipelines>

		<!-- resources pipeline / use noncaching for debugging -->
		<map:pipeline type="noncaching">
			<map:match pattern="resources/css/*.css">
				<map:read
					src="resource://com/mindquarry/teamspace/css/{1}.css" />
			</map:match>
			<map:match pattern="resources/images/*.png">
				<map:read
					src="resource://com/mindquarry/teamspace/images/{1}.png" />
			</map:match>			
			<map:match pattern="resources/buttons/*.*">
				<map:read src="resource://com/mindquarry/teamspace/buttons/{1}_button.{2}" />
			</map:match>
		</map:pipeline>
		
		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">
			<map:match pattern="">
				<map:call function="listTeamspacesForUser" />
			</map:match>
			<map:match pattern="views/teamspaceView">
				<map:generate src="jx/teamspace-view.jx" type="jx" />
				<map:transform src="xslt/teamspaces2html.xsl">
					<map:parameter name="pathInfo" value="{request:pathInfo}"/>
				</map:transform>
				<map:call resource="layouting" />
			</map:match>
		</map:pipeline>
		
		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">
			<map:match type="regexp" pattern="([a-z\-]+)/editMembers/$">
				<map:call function="editMembers">
					<map:parameter name="teamspaceId" value="{1}"/>
				</map:call>
			</map:match>
			<map:match pattern="views/membersView">
				<map:generate src="jx/members.jx" type="jx" />
				<map:serialize type="xhtml"/>
			</map:match>
		</map:pipeline>

		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">

			<!-- repository listing -->
			<map:match pattern="admin">
				<map:call function="handleForm">
					<map:parameter name="function"
						value="manageProjects" />
					<map:parameter name="definitionURI"
						value="forms/admin-form.xml" />
				</map:call>
			</map:match>

			<map:match pattern="*.instance">
				<map:generate type="jx" src="forms/{1}-template.xml"
					label="content1">
					<map:parameter name="locale"
						value="{flow-attribute:locale}" />
				</map:generate>

				<map:transform src="xslt/forms/form2html.xsl">
					<map:parameter name="resources-uri"
						value="{request:contextPath}/_cocoon/resources" />
				</map:transform>
				<map:call resource="layouting" />
			</map:match>			
		</map:pipeline>
		
		<map:pipeline>
			<!-- Continue a scenario. The continuation id is passed in the URL
				(typically used for GET requests) -->
			<map:match pattern="**/*.continue">
				<map:act type="setnohttpcache" />
				<map:call continuation="{2}" />
			</map:match>
		</map:pipeline>

	</map:pipelines>

</map:sitemap>