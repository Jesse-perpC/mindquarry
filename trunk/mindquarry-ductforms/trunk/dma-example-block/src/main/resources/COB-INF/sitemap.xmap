<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE map:sitemap [
<!ENTITY changelog_pattern "changes">
<!ENTITY browser_pattern "browser">
<!ENTITY file_view_pattern "view">
]>
<!-- Copyright (C) 2005 MindQuarry GmbH, All Rights Reserved -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

	<map:components>
		<map:generators default="dma">
			<map:generator name="dma"
				src="org.apache.cocoon.generation.TraversableSourceDescriptionGenerator"
				label="content" />
			<map:generator name="changelog"
				src="com.mindquarry.dma.viewer.generation.ChangeLogGenerator" />
		</map:generators>
		
		<map:actions> 
			<map:action name="revision-parameter-action" 
			src="com.mindquarry.dma.viewer.acting.RevisionParameterAction"/>
			
			<map:action name="project-resolver-action" 
			src="com.mindquarry.dma.viewer.acting.ProjectResolverAction"/>
		</map:actions>
		
		<!-- 
		<map:action-set name="dma-actions">
			<map:act type="project-resolver-action" />
			<map:act type="revision-parameter-action" />
		</map:action-set>
		-->
	</map:components>
	<map:views>
		<map:view name="content" from-label="content">
			<map:serialize type="xml" />
		</map:view>
	</map:views>
	<map:pipelines>
		<!-- use noncaching pipeline -->
		<map:pipeline type="noncaching">

			<!-- repository listing -->
			<map:match pattern="">
				<map:generate type="dma"
					src="file://{system-property:mindquarry.reposbasepath}/">
					<map:parameter name="depth" value="2" />
				</map:generate>
				<map:transform src="xslt/file/dir2html.xsl" />
				<map:serialize type="html" />
			</map:match>
			
			<!-- icons from tango jar -->
			<map:match pattern="icons/*/folder.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/places/folder.png" />
			</map:match>


			<map:match pattern="css/*.css">				
				<map:read src="css/{1}.css" />
			</map:match>
			
			<map:match pattern="icons/*/feed.png">
				<map:read src="icons/feed-icon-{1}.png" />
			</map:match>

			<map:match pattern="icons/*/application/pdf.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/mimetypes/x-office-document.png" />
			</map:match>

			<map:match pattern="icons/*/actions/*.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/actions/{2}.png" />
			</map:match>

			<map:match pattern="icons/*/text/html.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/mimetypes/x-office-document.png" />
			</map:match>

			<map:match pattern="icons/*/text/*.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/mimetypes/text-x-generic.png" />
			</map:match>

			<map:match pattern="icons/*/image/*.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/mimetypes/image-x-generic.png" />
			</map:match>

			<map:match pattern="icons/*/*/*.png">
				<map:read
					src="resource://org/tango-project/tango-icon-theme/{1}/mimetypes/x-office-document.png" />
			</map:match>


			<!-- 									     project  -->
			<map:match type="regexp" pattern="(&browser_pattern;)/([a-z]+)$">
				<map:redirect-to uri="{2}/"/>
			</map:match>
			
			<!-- 									   /(project)(folder(s))(folder without concluding '/') -->			
			<map:match type="regexp" pattern="(&browser_pattern;)/([a-z]+/)(.*[^\/])$">
				<map:redirect-to uri="{3}/"/>
			</map:match>
			
			<!-- 									     project  folder(s)        -->			
			<map:match type="regexp" pattern="(&browser_pattern;)/([a-z]+/)(.+/)*$">
				<map:act type="revision-parameter-action">
					<map:generate type="dma"
					src="dma:file://{system-property:mindquarry.reposbasepath}/{../2}{../3}?{revision-query}" />
				</map:act>
				<map:transform src="xslt/dma/dir2html.xsl">
					<map:parameter name="revision" value="0" />
					<map:parameter name="project" value="{2}" />
					<map:parameter name="path" value="{3}" />
					<map:parameter name="file_view_pattern" value="&file_view_pattern;" />
					<map:parameter name="changelog_pattern" value="&changelog_pattern;" />
				</map:transform>			
				<map:serialize type="html" />
			</map:match>		
			
			
			<!-- 									                project   path (without concluding "/")            -->
			<map:match type="regexp" pattern="(&file_view_pattern;)/([a-z]+/)(.*[^\/])$">
				<map:act type="revision-parameter-action">
					<map:read
						src="dma:file://{system-property:mindquarry.reposbasepath}/{2}{3}?{revision-query}" />
				</map:act>
			</map:match>
			
			<!-- 									     project  folder(s)       file             -->			
			<map:match type="regexp" pattern="(&changelog_pattern;)/([a-z]+/)([a-zA-Z0-9]+/)*([a-zA-Z0-9\.]*)$">
				<map:act type="revision-parameter-action">
					<map:generate type="changelog"
						src="dma:file://{system-property:mindquarry.reposbasepath}/{../2}{../3}{../4}?{revision-query}">
						<map:parameter name="revision" value="0" />
						<map:parameter name="entries" value="10" />
					</map:generate>
				</map:act>
				<map:transform src="xslt/log/log2html.xsl">
					<map:parameter name="project" value="{1}" />
					<map:parameter name="path" value="{2}" />
					<map:parameter name="file_view_pattern" value="&file_view_pattern;" />
					<map:parameter name="changelog_pattern" value="&changelog_pattern;" />
					<map:parameter name="browser_pattern" value="&browser_pattern;" />
				</map:transform>			
				<map:serialize type="html" />
			</map:match>
			
			<!-- 									     project  folder(s)       file             -->			
			<!-- 
			<map:match type="regexp" pattern="(atomfeed)/([a-z]+/)([a-zA-Z0-9]+/)*([a-zA-Z0-9\.]*)$">
				<map:act type="revision-parameter-action">
					<map:generate type="changelog"
						src="dma:file://{system-property:mindquarry.reposbasepath}/{../2}{../3}{../4}?{revision-query}">
						<map:parameter name="revision" value="0" />
						<map:parameter name="entries" value="10" />
					</map:generate>
				</map:act>
				<map:transform src="xslt/log/log2atom.xsl" />			
				<map:serialize type="html" />
			</map:match>
			-->
			
			<map:handle-errors>
				<map:generate type="exception" />
				<map:transform src="xslt/system/exception2html.xsl">
					<map:parameter name="contextPath"
						value="{request:contextPath}" />
					<map:parameter name="realPath" value="{realpath:}" />
				</map:transform>
				<map:serialize status-code="500" type="html" />
			</map:handle-errors>

		</map:pipeline>

	</map:pipelines>

</map:sitemap>

<!-- map:read src="dma:http://svn.collab.net/repos/svn/trunk/subversion/bindings/java/javahl/src/org/tigris/subversion/javahl/tests/SVNTests.java"/-->
