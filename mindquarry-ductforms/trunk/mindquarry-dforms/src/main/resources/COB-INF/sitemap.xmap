<?xml version="1.0" encoding="UTF-8"?>
<!--
	Copyright (C) 2006 MindQuarry GmbH, All Rights Reserved
-->
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

	<!-- DFORMS -->

	<map:components>
		<map:actions>
			<map:action name="log"
				src="com.mindquarry.webapp.acting.DebugLogAction" />
			<map:action name="log-params"
				src="com.mindquarry.webapp.acting.LogParametersAction" />
			<map:action name="request"
				src="org.apache.cocoon.acting.RequestParamAction" />
		</map:actions>

		<map:serializers>
			<!-- <map:serializer logger="sitemap.serializer.html"
				mime-type="text/html" name="html" pool-max="32"
				src="org.apache.cocoon.serialization.HTMLSerializer">
				<doctype-public>
				-//W3C//DTD HTML 4.01 Transitional//EN
				</doctype-public>
				<doctype-system>
				http://www.w3.org/TR/html4/loose.dtd
				</doctype-system>
				<encoding>UTF-8</encoding>
				</map:serializer> -->
		</map:serializers>

		<map:selectors>
			<map:selector name="lightbox-request"
				src="com.mindquarry.webapp.ajax.LightboxRequestSelector" />
			<map:selector name="ajax-request"
				src="org.apache.cocoon.ajax.AjaxRequestSelector" />
		</map:selectors>
	</map:components>

	<map:resources>
		<map:resource name="directories2model">
			<map:transform src="xsl/model/wrap-as-model.xsl" />
			<map:transform type="include" />
			<map:serialize type="xml" />
		</map:resource>

		<map:resource name="layouting">
			<map:transform src="block:resources:/xslt/html2html.xsl">
				<map:parameter name="fullPath"
					value="{request-param:callerFullPath}" />
				<map:parameter name="sitemapPath"
					value="{request-param:callerSitemapPath}" />
				<map:parameter name="user.agent"
					value="{request-header:User-Agent}" />
			</map:transform>
			<map:serialize type="html" />
		</map:resource>

	</map:resources>

	<map:flow language="javascript">
		<map:script src="flows/ductforms.js" />
	</map:flow>

	<map:pipelines>
		<map:pipeline type="noncaching">

			<!-- internal -->
			<!-- TODO: rename this or the other, file-specific matchers
				(eg. *.xml) so that there is no clash between mytask24.xml
				and this generic model provider here
				
				Note: this is also referenced via cocoon:/model.xml in
				addfield.xsl -->
			<map:match pattern="model.xml">
				<map:generate src="block:/dforms-model-directory.xml" />
				<map:call resource="directories2model" />
			</map:match>

			<!-- internal -->
			<!-- @virtual: getting basic model stuff -->
			<map:match pattern="dforms-model-directory.xml">
				<map:generate src="model" type="directory" />
				<!-- Note: for some reason the generic
					src="block:/directory2resourceincludes.xsl" reference
					does not work here -->
				<map:transform src="xsl/directory2resourceincludes.xsl" />
				<map:serialize type="xml" />
			</map:match>

			<!-- internal -->
			<!-- for child blocks to create includes of files in directories
				with the correct block:/resource/* source format -->
			<map:match pattern="directory2resourceincludes.xsl">
				<map:read src="xsl/directory2resourceincludes.xsl" />
			</map:match>

			<!--+ the true content of the model, here required fields have been added and
				| redundant declaration of the fields included is added
				+-->
			<map:match pattern="*.xml.plain">
				<map:select type="resource-exists">
					<!-- if it exists, show the document -->
					<map:when
						test="{request-param:baseURI}{request-param:documentID}.xml">
						<map:generate
							src="{request-param:baseURI}{request-param:documentID}.xml" />
						<map:transform src="xsl/model/addfield.xsl" />
						<map:serialize type="xml" />
					</map:when>
					<!-- else (if not) show the minimal document model including the required fields from the complete model -->
					<map:otherwise>
						<map:generate src="cocoon:/model.xml" />
						<map:transform src="xsl/model/plainmodel.xsl" />
						<map:serialize type="xml" />
					</map:otherwise>
				</map:select>
			</map:match>

			<!-- internal -->
			<!--+ the aggregation of the plain instance (data of the document)
				| and the aggregated models. This includes everything that is
				| and could be.
				+-->
			<map:match pattern="*.xml.model">
				<map:generate src="cocoon:/model.xml" />
				<map:transform src="xsl/model/model2modelinclude.xsl">
					<map:parameter name="instance"
						value="cocoon:/{1}.xml.plain">
					</map:parameter>
				</map:transform>
				<map:transform type="xinclude" />
				<map:transform src="xsl/model/cleanmodel.xsl" />
				<map:serialize type="xml" />
			</map:match>

			<!-- internal -->
			<!-- the generated form model including all possible fields  -->
			<map:match pattern="*.xml.form">
				<map:generate src="cocoon:/{1}.xml.model" />
				<map:transform src="xsl/model/modelincluded2form.xsl" />
				<map:serialize type="xml" />
			</map:match>

			<!-- internal -->
			<!-- the generated form template including only the selected fields -->
			<map:match pattern="*.xml.template">
				<map:generate src="cocoon:/{1}.xml.model" />
				<map:transform
					src="xsl/model/modelincluded2template.xsl">
					<map:parameter name="documentID"
						value="{request-param:documentID}" />
				</map:transform>
				<map:serialize type="xml" />
			</map:match>

			<!-- internal -->
			<!-- the form rendering pipeline called by the form controller -->
			<map:match pattern="*.xml.instance">
				<map:act type="log-params" />

				<!-- <map:generate src="cocoon:/{1}.xml.template" /> -->
				<!-- get the form template from a dynamic pipeline -->
				<map:generate type="jx" src="cocoon:/{1}.xml.template"
					label="content1">
					<map:parameter name="locale"
						value="{flow-attribute:locale}" />
				</map:generate>

				<!-- beautify our forms -->
				<!-- TODO: this could be overriden by the children -->
				<map:transform src="xsl/instance2html.xsl">
					<map:parameter name="baseURI"
						value="{request-param:baseURI}" />
					<map:parameter name="documentID"
						value="{request-param:documentID}" />
				</map:transform>

				<!-- standard cocoon form2html stylesheet + dojo-editor -->
				<map:transform src="xsl/forms/form2html.xsl">
					<map:parameter name="fullPath"
						value="{request-param:callerFullPath}" />
					<map:parameter name="sitemapPath"
						value="{request-param:callerSitemapPath}" />
				</map:transform>

				<!-- convert escaped html in dojo-editor content (marked with
					htmllize tags) into real html (nekohtml from cocoon-html) -->
				<map:transform type="nekohtml">
					<map:parameter name="tags" value="htmllize" />
				</map:transform>
				
				<map:transform src="xsl/remove-htmllize.xsl" />

				<!-- <map:serialize type="html" />-->
				<map:call resource="layouting" />
			</map:match>

			<!-- internal, for child -->
			<map:match pattern="show-document">
				<map:call function="handleForm">
					<map:parameter name="function" value="showPage" />
					<map:parameter name="baseURI"
						value="{request-param:baseURI}" />
					<map:parameter name="documentID"
						value="{request-param:documentID}" />
					<map:parameter name="definitionURI"
						value="block:/{request-param:documentID}.xml.form" />
				</map:call>
			</map:match>

			<!-- internal, for child -->
			<map:match pattern="edit-document">
				<map:act type="log-params" />
				<map:call function="handleForm">
					<map:parameter name="function" value="editPage" />
					<map:parameter name="baseURI"
						value="{request-param:baseURI}" />
					<map:parameter name="documentID"
						value="{request-param:documentID}" />
					<map:parameter name="definitionURI"
						value="cocoon:/{request-param:documentID}.xml.form" />
				</map:call>
			</map:match>

			<!-- internal, for child -->
			<map:match pattern="show-or-edit-document">
				<map:act type="log-params" />
				<map:select type="resource-exists">
					<!-- if it exists, show the document  -->
					<map:when
						test="{request-param:baseURI}{request-param:documentID}.xml">
						<map:read src="cocoon:/show-document" />
					</map:when>
					<!-- else edit the document -->
					<map:otherwise>
						<map:read src="cocoon:/edit-document" />
					</map:otherwise>
				</map:select>
			</map:match>

			<!-- internal, for child to retrieve xml -->
			<map:match pattern="document">
				<map:act type="log-params" />
				<map:read src="cocoon:/{request-param:documentID}.xml.plain" />
			</map:match>
			
			<!-- =========================================================== -->

			<!-- Continue a scenario. The continuation id is passed in the URL
				(typically used for GET requests) -->
			<map:match pattern="*.continue">
				<map:act type="log-params" />
				<map:call continuation="{1}" />
			</map:match>

			<!-- Continue a scenario. The continuation id is passed as a request
				parameter (typically used for POST request) -->
			<map:match pattern="continue">
				<map:call continuation="{1}" />
			</map:match>

			<!-- =========================================================== -->

			<!-- @virtual: for inheriting sitemap resources -->
			<map:match pattern="resource/**">
				<map:read src="{1}" />
			</map:match>

		</map:pipeline>

	</map:pipelines>

</map:sitemap>

